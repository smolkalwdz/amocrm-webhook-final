// Vercel Serverless Function –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫ –∏–∑ AmoCRM
module.exports = async (req, res) => {
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç node-fetch
  const fetch = (await import('node-fetch')).default;

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AmoCRM
  const AMO_SUBDOMAIN = 'dungeonbron'; // –í–∞—à –ø–æ–¥–¥–æ–º–µ–Ω AmoCRM
  const AMO_ACCESS_TOKEN = process.env.AMO_ACCESS_TOKEN; // –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –∫ AmoCRM

  // –í–∫–ª—é—á–∞–µ–º CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º OPTIONS –∑–∞–ø—Ä–æ—Å—ã
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // –¢–æ–ª—å–∫–æ GET –∑–∞–ø—Ä–æ—Å—ã
  if (req.method !== 'GET') {
    res.status(405).json({ error: 'Method not allowed' });
    return;
  }

  try {
    const { branch } = req.query; // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª–∏–∞–ª –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    console.log(`üîç –ó–∞–ø—Ä–æ—Å —Å–¥–µ–ª–æ–∫ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞: ${branch}`);

    if (!AMO_ACCESS_TOKEN) {
      console.error('‚ùå AMO_ACCESS_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      return res.status(500).json({ 
        error: 'AmoCRM —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
        deals: [] // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      });
    }

    console.log(`‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: ${AMO_ACCESS_TOKEN.substring(0, 20)}...`);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º pipeline_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∏–ª–∏–∞–ª–∞
    const pipelineId = branch === '–ü–æ–ª–µ–≤–∞—è' ? '5096621' : '5096620'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ ID –≤–æ—Ä–æ–Ω–æ–∫
    console.log(`üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º pipeline_id: ${pipelineId} –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);

    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    const apiUrl = `https://${AMO_SUBDOMAIN}.amocrm.ru/api/v4/leads?pipeline_id=${pipelineId}&status[]=47000707`;
    console.log(`üåê –ó–∞–ø—Ä–æ—Å –∫ AmoCRM: ${apiUrl}`);

    // –ü–æ–ª—É—á–∞–µ–º —Å–¥–µ–ª–∫–∏ –∏–∑ AmoCRM
    const response = await fetch(apiUrl, {
      headers: {
        'Authorization': `Bearer ${AMO_ACCESS_TOKEN}`,
        'Content-Type': 'application/json'
      }
    });

    console.log(`üì° –û—Ç–≤–µ—Ç AmoCRM: ${response.status} ${response.statusText}`);

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`‚ùå AmoCRM API error: ${response.status} - ${errorText}`);
      throw new Error(`AmoCRM API error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log(`üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç AmoCRM:`, JSON.stringify(data, null, 2));
    
    const leads = data._embedded?.leads || [];
    console.log(`üìä –ü–æ–ª—É—á–µ–Ω–æ ${leads.length} —Å–¥–µ–ª–æ–∫ –∏–∑ AmoCRM –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branch}`);

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–¥–µ–ª–∫–∏ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ)
    const deals = leads.map(lead => {
      const customFields = lead.custom_fields || [];
      console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–¥–µ–ª–∫—É ${lead.id}:`, lead.name);
      
      const getFieldValue = (fieldName) => {
        const field = customFields.find(f => f.name === fieldName);
        return field ? field.values[0].value : '';
      };

      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∏–∑ –ø–æ–ª—è "–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏"
      const datetime = getFieldValue('–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏');
      console.log(`üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏ –¥–ª—è ${lead.id}: ${datetime}`);
      
      let time = '19:00';
      let bookingDate = null;
      
      if (datetime) {
        try {
          if (typeof datetime === 'number' || !isNaN(datetime)) {
            const date = new Date(parseInt(datetime) * 1000);
            time = date.toTimeString().slice(0, 5);
            bookingDate = date.toISOString().split('T')[0]; // YYYY-MM-DD
            console.log(`‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ Unix timestamp: ${datetime} -> ${bookingDate} ${time}`);
          } else if (datetime.includes(' ')) {
            const parts = datetime.split(' ');
            if (parts.length >= 2) {
              time = parts[1].substring(0, 5);
              // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
              const datePart = parts[0];
              if (datePart.includes('.')) {
                const [day, month, year] = datePart.split('.');
                bookingDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                console.log(`‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –¥–∞—Ç—ã: ${datetime} -> ${bookingDate} ${time}`);
              }
            }
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏:', e);
        }
      }

      const deal = {
        id: lead.id.toString(),
        name: getFieldValue('–ò–º—è –ë—Ä–æ–Ω–∏') || lead.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
        time: time,
        guests: parseInt(getFieldValue('–ö–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π')) || 1,
        phone: getFieldValue('–¢–µ–ª–µ—Ñ–æ–Ω') || '',
        comment: getFieldValue('–ö–æ–º–º–µ–Ω—Ç –∫ –±—Ä–æ–Ω–∏') || '',
        branch: branch,
        zone: getFieldValue('–ó–æ–Ω–∞') || '–ó–æ–Ω–∞ 1',
        hasVR: getFieldValue('VR') === '–î–∞',
        hasShisha: getFieldValue('–ö–∞–ª—å—è–Ω') === '–î–∞',
        leadId: lead.id,
        status: lead.status_id,
        bookingDate: bookingDate // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –±—Ä–æ–Ω–∏
      };

      console.log(`üìã –°–æ–∑–¥–∞–Ω–∞ —Å–¥–µ–ª–∫–∞: ${deal.name} –Ω–∞ ${deal.bookingDate} –≤ ${deal.time}`);
      return deal;
    });

    console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${deals.length} —Å–¥–µ–ª–æ–∫ (–≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ)`);

    res.status(200).json({
      success: true,
      deals: deals,
      timestamp: new Date().toISOString(),
      totalLeads: leads.length,
      processedDeals: deals.length
    });

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫ –∏–∑ AmoCRM:', error.message);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    const mockDeals = [
      {
        id: '1',
        name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        time: '19:00',
        guests: 4,
        phone: '+7 (999) 123-45-67',
        comment: '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è',
        branch: branch || '–ú–°–ö',
        zone: '–ó–æ–Ω–∞ 3',
        hasVR: true,
        hasShisha: false,
        leadId: '1',
        status: '47000707',
        bookingDate: '2025-08-08'
      },
      {
        id: '2',
        name: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
        time: '20:30',
        guests: 2,
        phone: '+7 (999) 234-56-78',
        comment: '–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω',
        branch: branch || '–ü–æ–ª–µ–≤–∞—è',
        zone: '–ó–æ–Ω–∞ 1',
        hasVR: false,
        hasShisha: true,
        leadId: '2',
        status: '47000707',
        bookingDate: '2025-08-09'
      }
    ].filter(deal => deal.branch === (branch || '–ú–°–ö'));

    console.log(`üîÑ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: ${mockDeals.length} —Å–¥–µ–ª–æ–∫`);

    res.status(200).json({
      success: false,
      error: error.message,
      deals: mockDeals,
      timestamp: new Date().toISOString(),
      debug: {
        tokenConfigured: !!process.env.AMO_ACCESS_TOKEN,
        tokenLength: process.env.AMO_ACCESS_TOKEN ? process.env.AMO_ACCESS_TOKEN.length : 0,
        branch: branch,
        pipelineId: branch === '–ü–æ–ª–µ–≤–∞—è' ? '5096621' : '5096620'
      }
    });
  }
}; 